# Copyright 2020 ETH Zurich and University of Bologna.
# Licensed under the Apache License, Version 2.0, see LICENSE for details.
# SPDX-License-Identifier: Apache-2.0

# Run functional regression checks
name: ci
on: [push]

jobs:
  ###########
  # Banshee #
  ###########
  Banshee:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust:
        - stable
        - beta
        - nightly
        - 1.46.0    # minimum supported version
    steps:
    - uses: actions/checkout@v2
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: ${{ matrix.rust }}
        override: true
        components: rustfmt
    - uses: KyleMayes/install-llvm-action@v1
      with:
        version: '10.0'
        directory: ${{ runner.temp }}/llvm
    - working-directory: sw/banshee
      run: cargo build
    - working-directory: sw/banshee
      run: cargo test --all
    - working-directory: sw/banshee
      run: make test TERM=xterm-256color LOG_FAILED=`mktemp` LOG_TOTAL=`mktemp`

  #############
  # snRuntime #
  #############
  snRuntime:
    container:
      image: ghcr.io/pulp-platform/snitch
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: cd sw/snRuntime && mkdir build && cd build && cmake .. && make
    - name: Test
      run: cd sw/snRuntime/build && make test

  ##########
  # snBLAS #
  ##########
  snBLAS:
    container:
      image: ghcr.io/pulp-platform/snitch
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: cd sw/snBLAS && mkdir build && cd build && cmake .. && make
    - name: Test
      run: cd sw/snBLAS/build && make test

  ##################
  # Snitch Cluster #
  ##################
  snitch_cluster_default:
    container:
      image: ghcr.io/pulp-platform/snitch
    name: Snitch Cluster Default Config
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Build Hardware
      run: |
        cd hw/system/snitch_cluster && make bin/snitch_cluster.vlt
    - name: Build Software
      run: |
        cd hw/system/snitch_cluster/sw && mkdir build && cd build && cmake .. && make
    - name: Run Unit Tests
      run: |
        cd hw/system/snitch_cluster/sw/build && make test
