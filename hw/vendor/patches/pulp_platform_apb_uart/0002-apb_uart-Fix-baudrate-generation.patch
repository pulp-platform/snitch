From 429b657693d2277a0062976fab2646b081505044 Mon Sep 17 00:00:00 2001
From: Nils Wistoff <nwistoff@iis.ee.ethz.ch>
Date: Wed, 13 Oct 2021 13:57:00 +0200
Subject: [PATCH] apb_uart: Fix baudrate generation

See https://github.com/pulp-platform/apb_uart/pull/2

Signed-off-by: Nils Wistoff <nwistoff@iis.ee.ethz.ch>
---
 src/apb_uart.sv     | 2 +-
 src/uart_baudgen.sv | 6 +++---
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/apb_uart.sv b/src/apb_uart.sv
index a1643f0..535eadd 100644
--- a/src/apb_uart.sv
+++ b/src/apb_uart.sv
@@ -236,7 +236,7 @@ always @(posedge CLK or posedge iRST)
   if ((iRST ==  1'b1))
     begin
        /* block const 263 */
-       iDLL <= (0<<7)|(0<<6)|(0<<5)|(0<<4)|(0<<3)|(0<<2)|(0<<1)|(0<<0);
+       iDLL <= (0<<7)|(0<<6)|(0<<5)|(0<<4)|(0<<3)|(0<<2)|(0<<1)|(0<<1);
        /* block const 263 */
        iDLM <= (0<<7)|(0<<6)|(0<<5)|(0<<4)|(0<<3)|(0<<2)|(0<<1)|(0<<0);
     end
diff --git a/src/uart_baudgen.sv b/src/uart_baudgen.sv
index 0475694..47904ac 100644
--- a/src/uart_baudgen.sv
+++ b/src/uart_baudgen.sv
@@ -61,13 +61,13 @@ iCounter <= (0<<15)|(0<<14)|(0<<13)|(0<<12)|(0<<11)|(0<<10)|(0<<9)|(0<<8)|(0<<7)
       end
           else if     ((CE ==  1'b1))
           begin
-      iCounter <= iCounter + 1; // 413
+      iCounter <= iCounter - 1; // 413
               end
       BAUDTICK <=  1'b0; // 413
-    if ((iCounter == $unsigned(DIVIDER)))
+    if (iCounter == '0)
           begin
       /* block const 263 */
-iCounter <= (0<<15)|(0<<14)|(0<<13)|(0<<12)|(0<<11)|(0<<10)|(0<<9)|(0<<8)|(0<<7)|(0<<6)|(0<<5)|(0<<4)|(0<<3)|(0<<2)|(0<<1)|(0<<0);
+iCounter <= $unsigned(DIVIDER) - 1;
 BAUDTICK <=  1'b1; // 413
               end
       
-- 
2.16.5

