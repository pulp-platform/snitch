# Copyright 2020 ETH Zurich and University of Bologna.
# Solderpad Hardware License, Version 0.51, see LICENSE for details.
# SPDX-License-Identifier: SHL-0.51
#
# Nils Wistoff <nwistoff@iis.ee.ethz.ch>

MKFILE_PATH := $(abspath $(lastword $(MAKEFILE_LIST)))
MKFILE_DIR  := $(dir $(MKFILE_PATH))
ROOT        := ${MKFILE_DIR}../../../../..
DEBUG       ?= 0

VIVADO ?= vivado
BENDER ?= bender
VIVADO_ARGS = -nojournal -nolog

# List of IP to build
IPS += occamy_xilinx

# IP-specific bender flags
BENDER_FLAGS-occamy_xilinx = -t bscane

# Output directory
BUILD = build

all: $(addprefix ${BUILD}/,$(addsuffix /component.xml, $(IPS)))

# Phony-targets for convenience
.PHONY: occamy_xilinx
occamy_xilinx: build/occamy_xilinx/component.xml

clean:
	rm -rf .Xil ${BUILD} *.jou *.log ${BUILD}/*/{Bender.lock,.bender}

# Keep the bender-generated sources
.PRECIOUS: ${BUILD}/%/sources.tcl

# Generate sources file using bender
# We use second expansion https://www.gnu.org/software/make/manual/make.html#Secondary-Expansion
# to use the pattern rule match in the target. This makes `sources.tcl` outdated if any
# file generated by `bender script flist` has changed
.SECONDEXPANSION:
${BUILD}/%/sources.tcl: $$(shell make -C $$* 1>&2) $$(shell $(BENDER) -d $$* script flist | sed '/^+incdir+/d' | xargs) %/Bender.yml
	@mkdir -p ${BUILD}/$*
	@echo "[BENDER]: $*"
	$(BENDER) -d $* script vivado -t vivado_ipx ${BENDER_FLAGS-$*} > $@
	$(BENDER) -d $* script vivado -t vivado_ipx ${BENDER_FLAGS-$*} --only-defines --only-includes --no-simset > ${BUILD}/$*/inc_def.tcl

# Package the IP
${BUILD}/%/component.xml: package_ip.tcl ${BUILD}/%/sources.tcl
	@echo "[VIVADO]: $*"
	$(VIVADO) $(VIVADO_ARGS) -mode batch -source package_ip.tcl -tclargs $* ${BUILD}
